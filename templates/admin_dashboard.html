<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kavach Jyotish Kendra</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<section class="section" style="background: linear-gradient(to bottom right, rgba(107, 70, 193, 0.05), rgba(245, 158, 11, 0.05)); min-height: 80vh;">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 class="text-gradient" style="font-size: 2rem; margin-bottom: 0.5rem;">Admin Dashboard</h1>
                <p style="color: var(--gray-600);">Manage appointments, messages, blog posts, and testimonials</p>
            </div>
            <a href="/api/logout" class="btn btn-outline">
                <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>
                Logout
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-4" style="margin-bottom: 3rem;">
            <div class="card">
                <div style="text-align: center;">
                    <h3 id="appointments-count">0</h3>
                    <p>Appointments</p>
                </div>
            </div>
            <div class="card">
                <div style="text-align: center;">
                    <h3 id="messages-count">0</h3>
                    <p>Messages</p>
                </div>
            </div>
            <div class="card">
                <div style="text-align: center;">
                    <h3 id="blog-count">0</h3>
                    <p>Blog Posts</p>
                </div>
            </div>
            <div class="card">
                <div style="text-align: center;">
                    <h3 id="testimonials-count">0</h3>
                    <p>Testimonials</p>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <div class="tab-nav" style="display: flex; border-bottom: 2px solid var(--gray-200); margin-bottom: 2rem;">
                <button class="tab-btn active" onclick="showTab('appointments')">Appointments</button>
                <button class="tab-btn" onclick="showTab('contacts')">Messages</button>
                <button class="tab-btn" onclick="showTab('blog')">Blog Posts</button>
                <button class="tab-btn" onclick="showTab('testimonials')">Testimonials</button>
            </div>

            <!-- Appointments Tab -->
            <div id="appointments-tab" class="tab-content active">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Appointment Management</h3>
                    <div id="appointments-list">
                        <!-- Appointments will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="contacts-tab" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Contact Messages</h3>
                    <div id="messages-list">
                        <!-- Messages will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Blog Posts Tab -->
            <div id="blog-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Blog Posts</h3>
                        <button class="btn btn-primary" onclick="showAddBlogForm()">
                            <i class="fas fa-plus" style="margin-right: 8px;"></i>
                            Add New Post
                        </button>
                    </div>
                    <div id="blog-list">
                        <!-- Blog posts will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Testimonials Tab -->
            <div id="testimonials-tab" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Testimonials</h3>
                    <div id="testimonials-list">
                        <!-- Testimonials will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Tab functionality
function showTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Load data for the selected tab
    loadTabData(tabName);
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'appointments':
            fetchAppointments();
            break;
        case 'contacts':
            fetchMessages();
            break;
        case 'blog':
            fetchBlogPosts();
            break;
        case 'testimonials':
            fetchTestimonials();
            break;
    }
}

async function fetchAppointments() {
    try {
        const response = await fetch('/api/appointments', { credentials: 'include' });
        if (!response.ok) {
            if (response.status === 401) window.location.href = '/admin_login';
            return;
        }
        const appointments = await response.json();
        
        document.getElementById('appointments-count').textContent = appointments.length;
        
        const appointmentsList = document.getElementById('appointments-list');
        appointmentsList.innerHTML = '';

        if (appointments.length === 0) {
            appointmentsList.innerHTML = '<p>No appointments found.</p>';
            return;
        }

        appointments.forEach(app => {
            const appointmentDiv = document.createElement('div');
            appointmentDiv.className = 'appointment-item';
            appointmentDiv.innerHTML = `
                <div style="border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--spiritual-purple);">${app.name}</h4>
                            <p style="margin: 0.25rem 0;"><strong>Service:</strong> ${app.serviceType}</p>
                            <p style="margin: 0.25rem 0;"><strong>WhatsApp:</strong> ${app.whatsapp}</p>
                            <p style="margin: 0.25rem 0;"><strong>Email:</strong> ${app.email || 'Not provided'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Date of Birth:</strong> ${app.dateOfBirth || 'Not provided'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Time of Birth:</strong> ${app.timeOfBirth || 'Not provided'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Place of Birth:</strong> ${app.placeOfBirth || 'Not provided'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Message:</strong> ${app.message || 'No message'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Created:</strong> ${new Date(app.created_at).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge ${app.status}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                ${app.status}
                            </span>
                            <div style="margin-top: 0.5rem;">
                                <select onchange="updateAppointmentStatus(${app.id}, this.value)" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="confirmed" ${app.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="completed" ${app.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${app.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            appointmentsList.appendChild(appointmentDiv);
        });

    } catch (error) {
        console.error("Failed to fetch appointments", error);
    }
}

async function fetchMessages() {
    try {
        const response = await fetch('/api/contact', { credentials: 'include' });
        if (!response.ok) {
            if (response.status === 401) window.location.href = '/admin_login';
            return;
        }
        const messages = await response.json();
        
        document.getElementById('messages-count').textContent = messages.length;
        
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = '';

        if (messages.length === 0) {
            messagesList.innerHTML = '<p>No messages found.</p>';
            return;
        }

        messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            messageDiv.innerHTML = `
                <div style="border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--spiritual-purple);">${msg.name}</h4>
                            <p style="margin: 0.25rem 0;"><strong>Email:</strong> ${msg.email}</p>
                            <p style="margin: 0.25rem 0;"><strong>Subject:</strong> ${msg.subject || 'No subject'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Message:</strong> ${msg.message}</p>
                            <p style="margin: 0.25rem 0;"><strong>Received:</strong> ${new Date(msg.created_at).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge ${msg.is_read ? 'read' : 'unread'}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                ${msg.is_read ? 'Read' : 'Unread'}
                            </span>
                            ${!msg.is_read ? `<button onclick="markAsRead(${msg.id})" class="btn btn-sm" style="margin-top: 0.5rem;">Mark as Read</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            messagesList.appendChild(messageDiv);
        });

    } catch (error) {
        console.error("Failed to fetch messages", error);
    }
}

async function fetchBlogPosts() {
    try {
        const response = await fetch('/api/blog/all', { credentials: 'include' });
        if (!response.ok) {
            if (response.status === 401) window.location.href = '/admin_login';
            return;
        }
        const posts = await response.json();
        
        document.getElementById('blog-count').textContent = posts.length;
        
        const blogList = document.getElementById('blog-list');
        blogList.innerHTML = '';

        if (posts.length === 0) {
            blogList.innerHTML = '<p>No blog posts found.</p>';
            return;
        }

        posts.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'blog-item';
            postDiv.innerHTML = `
                <div style="border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--spiritual-purple);">${post.title}</h4>
                            <p style="margin: 0.25rem 0;"><strong>Category:</strong> ${post.category}</p>
                            <p style="margin: 0.25rem 0;"><strong>Excerpt:</strong> ${post.excerpt}</p>
                            <p style="margin: 0.25rem 0;"><strong>Published:</strong> ${post.is_published ? 'Yes' : 'No'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Created:</strong> ${new Date(post.created_at).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge ${post.is_published ? 'published' : 'draft'}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                ${post.is_published ? 'Published' : 'Draft'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            blogList.appendChild(postDiv);
        });

    } catch (error) {
        console.error("Failed to fetch blog posts", error);
    }
}

async function fetchTestimonials() {
    try {
        const response = await fetch('/api/testimonials/all', { credentials: 'include' });
        if (!response.ok) {
            if (response.status === 401) window.location.href = '/admin_login';
            return;
        }
        const testimonials = await response.json();
        
        document.getElementById('testimonials-count').textContent = testimonials.length;
        
        const testimonialsList = document.getElementById('testimonials-list');
        testimonialsList.innerHTML = '';

        if (testimonials.length === 0) {
            testimonialsList.innerHTML = '<p>No testimonials found.</p>';
            return;
        }

        testimonials.forEach(testimonial => {
            const testimonialDiv = document.createElement('div');
            testimonialDiv.className = 'testimonial-item';
            testimonialDiv.innerHTML = `
                <div style="border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--spiritual-purple);">${testimonial.name}</h4>
                            <p style="margin: 0.25rem 0;"><strong>Location:</strong> ${testimonial.location}</p>
                            <p style="margin: 0.25rem 0;"><strong>Service:</strong> ${testimonial.service}</p>
                            <p style="margin: 0.25rem 0;"><strong>Rating:</strong> ${'⭐'.repeat(testimonial.rating)}</p>
                            <p style="margin: 0.25rem 0;"><strong>Testimonial:</strong> ${testimonial.text}</p>
                            <p style="margin: 0.25rem 0;"><strong>Submitted:</strong> ${new Date(testimonial.created_at).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge ${testimonial.is_approved ? 'approved' : 'pending'}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                ${testimonial.is_approved ? 'Approved' : 'Pending'}
                            </span>
                            ${!testimonial.is_approved ? `<button onclick="approveTestimonial(${testimonial.id})" class="btn btn-sm" style="margin-top: 0.5rem;">Approve</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            testimonialsList.appendChild(testimonialDiv);
        });

    } catch (error) {
        console.error("Failed to fetch testimonials", error);
    }
}

async function updateAppointmentStatus(id, status) {
    try {
        const response = await fetch(`/api/appointments/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            fetchAppointments(); // Refresh the list
        }
    } catch (error) {
        console.error("Failed to update appointment status", error);
    }
}

async function markAsRead(id) {
    try {
        const response = await fetch(`/api/contact/${id}/read`, {
            method: 'PATCH',
            credentials: 'include'
        });
        
        if (response.ok) {
            fetchMessages(); // Refresh the list
        }
    } catch (error) {
        console.error("Failed to mark message as read", error);
    }
}

async function approveTestimonial(id) {
    try {
        const response = await fetch(`/api/testimonials/${id}/approve`, {
            method: 'PATCH',
            credentials: 'include'
        });
        
        if (response.ok) {
            fetchTestimonials(); // Refresh the list
        }
    } catch (error) {
        console.error("Failed to approve testimonial", error);
    }
}

// Load initial data when page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchAppointments();
    fetchMessages();
    fetchBlogPosts();
    fetchTestimonials();
});
</script>

<style>
/* Tab styles */
.tab-btn {
    padding: 1rem 2rem;
    border: none;
    background: none;
    cursor: pointer;
    color: var(--gray-600);
    transition: all 0.3s ease;
}
.tab-btn:hover {
    color: var(--spiritual-purple);
}
.tab-btn.active {
    border-bottom: 3px solid var(--spiritual-purple);
    color: var(--spiritual-purple);
    font-weight: 600;
}

.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}

/* Status badge styles */
.status-badge.pending {
    background-color: #fef3c7;
    color: #92400e;
}
.status-badge.confirmed {
    background-color: #dbeafe;
    color: #1e40af;
}
.status-badge.completed {
    background-color: #d1fae5;
    color: #065f46;
}
.status-badge.cancelled {
    background-color: #fee2e2;
    color: #991b1b;
}
.status-badge.unread {
    background-color: #fef3c7;
    color: #92400e;
}
.status-badge.read {
    background-color: #d1fae5;
    color: #065f46;
}
.status-badge.published {
    background-color: #d1fae5;
    color: #065f46;
}
.status-badge.draft {
    background-color: #f3f4f6;
    color: #374151;
}
.status-badge.approved {
    background-color: #d1fae5;
    color: #065f46;
}

/* Button styles */
.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    background-color: var(--spiritual-purple);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.btn-sm:hover {
    background-color: var(--spiritual-purple-deep);
}
</style>

</body>
</html>