{% extends "base.html" %}

{% block title %}Admin Dashboard - Kavach Jyotish Kendra{% endblock %}

{% block content %}
<section class="section" style="background: linear-gradient(to bottom right, rgba(107, 70, 193, 0.05), rgba(245, 158, 11, 0.05)); min-height: 80vh;">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 class="text-gradient" style="font-size: 2rem; margin-bottom: 0.5rem;">Admin Dashboard</h1>
                <p style="color: var(--gray-600);">Manage appointments, messages, blog posts, and testimonials</p>
            </div>
            <a href="/admin/logout" class="btn btn-outline">
                <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>
                Logout
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-4" style="margin-bottom: 3rem;">
            <div class="card" style="text-align: center;">
                <i class="fas fa-calendar-alt" style="font-size: 2rem; color: var(--spiritual-purple); margin-bottom: 1rem;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--spiritual-purple); margin-bottom: 0.5rem;">
                    {{ appointments|length }}
                </div>
                <div style="color: var(--gray-600);">Total Appointments</div>
            </div>

            <div class="card" style="text-align: center;">
                <i class="fas fa-envelope" style="font-size: 2rem; color: var(--saffron); margin-bottom: 1rem;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--saffron); margin-bottom: 0.5rem;">
                    {{ contacts|length }}
                </div>
                <div style="color: var(--gray-600);">Contact Messages</div>
            </div>

            <div class="card" style="text-align: center;">
                <i class="fas fa-file-text" style="font-size: 2rem; color: var(--spiritual-purple); margin-bottom: 1rem;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--spiritual-purple); margin-bottom: 0.5rem;">
                    {{ blogs|length }}
                </div>
                <div style="color: var(--gray-600);">Blog Posts</div>
            </div>

            <div class="card" style="text-align: center;">
                <i class="fas fa-star" style="font-size: 2rem; color: var(--saffron); margin-bottom: 1rem;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--saffron); margin-bottom: 0.5rem;">
                    {{ testimonials|length }}
                </div>
                <div style="color: var(--gray-600);">Testimonials</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <div class="tab-nav" style="display: flex; border-bottom: 2px solid var(--gray-200); margin-bottom: 2rem;">
                <button class="tab-btn active" onclick="showTab('appointments')" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid var(--spiritual-purple); color: var(--spiritual-purple); font-weight: 600;">
                    Appointments
                </button>
                <button class="tab-btn" onclick="showTab('contacts')" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; color: var(--gray-600);">
                    Messages
                </button>
                <button class="tab-btn" onclick="showTab('blog')" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; color: var(--gray-600);">
                    Blog Posts
                </button>
                <button class="tab-btn" onclick="showTab('testimonials')" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; color: var(--gray-600);">
                    Testimonials
                </button>
            </div>

            <!-- Appointments Tab -->
            <div id="appointments-tab" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--spiritual-purple-deep);">Appointment Management</h3>
                    
                    {% if appointments %}
                        {% for appointment in appointments %}
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">{{ appointment.name }}</h4>
                                    <div style="display: flex; align-items: center; color: var(--gray-600); margin-bottom: 0.25rem;">
                                        <i class="fas fa-phone" style="margin-right: 8px;"></i>
                                        {{ appointment.whatsapp }}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="status-badge status-{{ appointment.status }}" style="padding: 4px 12px; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                                        {{ appointment.status.title() }}
                                    </span>
                                    <select onchange="updateAppointmentStatus('{{ appointment._id }}', this.value)" style="padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <option value="">Update Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; color: var(--gray-600); font-size: 0.875rem;">
                                <div><strong>Service:</strong> {{ appointment.service_type.title() }}</div>
                                <div><strong>Created:</strong> {{ appointment.created_at.strftime('%Y-%m-%d %H:%M') if appointment.created_at else 'N/A' }}</div>
                            </div>
                            {% if appointment.message %}
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--gray-100); border-radius: 4px; font-size: 0.875rem;">
                                <strong>Message:</strong> {{ appointment.message }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            No appointments found
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contact Messages Tab -->
            <div id="contacts-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--spiritual-purple-deep);">Contact Messages</h3>
                    
                    {% if contacts %}
                        {% for contact in contacts %}
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">{{ contact.name }}</h4>
                                    <p style="color: var(--gray-600); margin-bottom: 0.25rem;">{{ contact.email }}</p>
                                    {% if contact.subject %}
                                    <p style="color: var(--gray-500); font-size: 0.875rem;"><strong>Subject:</strong> {{ contact.subject }}</p>
                                    {% endif %}
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    {% if contact.is_read %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #DCFCE7; color: #166534; font-size: 0.875rem; font-weight: 500;">Read</span>
                                    {% else %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #FEE2E2; color: #991B1B; font-size: 0.875rem; font-weight: 500;">Unread</span>
                                        <button onclick="markContactAsRead('{{ contact._id }}')" class="btn btn-primary" style="padding: 4px 12px; font-size: 0.875rem;">
                                            Mark Read
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--gray-100); border-radius: 4px; font-size: 0.875rem;">
                                {{ contact.message }}
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--gray-500); font-size: 0.75rem;">
                                {{ contact.created_at.strftime('%Y-%m-%d %H:%M') if contact.created_at else 'N/A' }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            No contact messages found
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Blog Posts Tab -->
            <div id="blog-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--spiritual-purple-deep);">Blog Posts Management</h3>
                        <button onclick="showBlogForm()" class="btn btn-primary">
                            <i class="fas fa-plus" style="margin-right: 8px;"></i>
                            Add New Post
                        </button>
                    </div>
                    
                    <!-- Blog Form (Hidden by default) -->
                    <div id="blog-form" style="display: none; background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Create New Blog Post</h4>
                        <form id="blogPostForm">
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label class="form-label">Title</label>
                                    <input type="text" name="title" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select name="category" class="form-select" required>
                                        <option value="">Select Category</option>
                                        <option value="Daily Horoscope">Daily Horoscope</option>
                                        <option value="Spiritual Wisdom">Spiritual Wisdom</option>
                                        <option value="Vastu Guidance">Vastu Guidance</option>
                                        <option value="Gemstone Therapy">Gemstone Therapy</option>
                                        <option value="Astrology Tips">Astrology Tips</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Excerpt</label>
                                <textarea name="excerpt" class="form-textarea" rows="2" placeholder="Brief description of the post" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Content</label>
                                <textarea name="content" class="form-textarea" rows="6" placeholder="Full blog post content" required></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-primary">Create Post</button>
                                <button type="button" onclick="hideBlogForm()" class="btn btn-outline">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    {% if blogs %}
                        {% for blog in blogs %}
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">{{ blog.title }}</h4>
                                    <p style="color: var(--gray-600); margin-bottom: 1rem;">{{ blog.excerpt }}</p>
                                    <div style="display: flex; gap: 2rem; color: var(--gray-500); font-size: 0.875rem;">
                                        <span><strong>Category:</strong> {{ blog.category }}</span>
                                        <span><strong>Status:</strong> {{ 'Published' if blog.is_published else 'Draft' }}</span>
                                        <span><strong>Created:</strong> {{ blog.created_at.strftime('%Y-%m-%d') if blog.created_at else 'N/A' }}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    {% if blog.is_published %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #DCFCE7; color: #166534; font-size: 0.875rem;">Published</span>
                                    {% else %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #FEF3C7; color: #92400E; font-size: 0.875rem;">Draft</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            No blog posts found
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Testimonials Tab -->
            <div id="testimonials-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--spiritual-purple-deep);">Testimonials Management</h3>
                    
                    {% if testimonials %}
                        {% for testimonial in testimonials %}
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">{{ testimonial.name }}</h4>
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <span style="color: var(--gray-600);">{{ testimonial.location }}</span>
                                        <div>
                                            {% for i in range(testimonial.rating) %}
                                            <i class="fas fa-star" style="color: var(--saffron);"></i>
                                            {% endfor %}
                                            {% for i in range(5 - testimonial.rating) %}
                                            <i class="far fa-star" style="color: var(--gray-300);"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <span style="padding: 2px 8px; border-radius: 4px; background: var(--saffron-light); color: var(--saffron-dark); font-size: 0.75rem;">{{ testimonial.service }}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    {% if testimonial.is_approved %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #DCFCE7; color: #166534; font-size: 0.875rem; font-weight: 500;">Approved</span>
                                    {% else %}
                                        <span style="padding: 4px 12px; border-radius: 4px; background: #FEE2E2; color: #991B1B; font-size: 0.875rem; font-weight: 500;">Pending</span>
                                        <button onclick="approveTestimonial('{{ testimonial._id }}')" class="btn btn-primary" style="padding: 4px 12px; font-size: 0.875rem;">
                                            Approve
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--gray-100); border-radius: 4px; font-size: 0.875rem; font-style: italic;">
                                "{{ testimonial.text }}"
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--gray-500); font-size: 0.75rem;">
                                {{ testimonial.created_at.strftime('%Y-%m-%d %H:%M') if testimonial.created_at else 'N/A' }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            No testimonials found
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Tab functionality
function showTab(tabName) {
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.style.display = 'none');
    
    // Remove active class from all buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = 'none';
        btn.style.color = 'var(--gray-600)';
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // Add active class to clicked button
    event.target.classList.add('active');
    event.target.style.borderBottom = '3px solid var(--spiritual-purple)';
    event.target.style.color = 'var(--spiritual-purple)';
}

// Blog form functions
function showBlogForm() {
    document.getElementById('blog-form').style.display = 'block';
}

function hideBlogForm() {
    document.getElementById('blog-form').style.display = 'none';
    document.getElementById('blogPostForm').reset();
}

// Blog post form submission
document.getElementById('blogPostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitForm('blogPostForm', '/admin/blog');
});
</script>

<style>
.status-pending { background: #FEF3C7; color: #92400E; }
.status-confirmed { background: #DCFCE7; color: #166534; }
.status-completed { background: #DBEAFE; color: #1E40AF; }
.status-cancelled { background: #FEE2E2; color: #991B1B; }
</style>
{% endblock %}